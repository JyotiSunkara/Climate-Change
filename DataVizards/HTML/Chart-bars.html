<!DOCTYPE html>
<meta charset="utf-8">
<style>

svg {
  font: 10px sans-serif;
}


.bar {
  fill: royalblue;
  clip-path: url(#clip);
}
  
.subBar { 
  fill: black;
  opacity: 1;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.brush .extent {
  stroke: #fff;
  fill: steelblue;
  fill-opacity: .25;
  shape-rendering: crispEdges;
}

select {
        width: 140px;
        height: 35px;
        padding: 4px;
        border-radius:3px;
        box-shadow: 2px 2px 8px #999;
        background: #eee;
        border: none;
        outline: none;
        display: inline-block;
        -webkit-appearance:none;
        -moz-appearance: none;
        appearance: none;
        cursor: pointer;
    }
    label {
    position: relative;
    }
    label:after {
        content:'<>';
        font: 11px "Consolas", monospace;
        color: #666;
        -webkit-transform: rotate(90deg);
        -moz-transform: rotate(90deg);
        -ms-transform: rotate(90deg);
        transform: rotate(90deg);
        right: 8px; 
        top:2px;
        padding: 0 0 2px;
        border-bottom: 1px solid #ddd;
        position: absolute;
        pointer-events: none;
    }
    label:before {
        content: '';
        right: 6px; 
        top:0px;
        width: 20px; 
        height: 20px;
        background: #eee;
        position: absolute;
        pointer-events: none;
        display: block;
    }

</style>
<h2><i>Average Temperatures Of The Selected City For Months From 1980's Onwards</i></h2>
<body>

    <div class="dropdead"></div>
</body>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script>
  
var bardata = [];
// var datum = {}
// datum.date = 0
// datum.average = 0
// bardata.push(datum)

for (var i = 0; i < 300; i++) {
  var datum = {};
  datum.date = i;
  datum.average = i*0.1 + Math.random() *19.20 - Math.random() *3.620;
  bardata.push(datum);
}  
  
var margin = {top: 10, right: 10, bottom: 100, left: 40},
    margin2 = {top: 430, right: 10, bottom: 20, left: 40},
    width = 750 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom,
    height2 = 500 - margin2.top - margin2.bottom;

var x = d3.scale.ordinal().rangeBands([0, width], .1),
    x2 = d3.scale.ordinal().rangeBands([0, width], .1),
    y = d3.scale.linear().range([height, 0]),
    y2 = d3.scale.linear().range([height2, 0]);

var xAxis = d3.svg.axis().scale(x).orient("bottom"),
    xAxis2 = d3.svg.axis().scale(x2).orient("bottom").tickValues([]),
    yAxis = d3.svg.axis().scale(y).orient("left");

		x.domain(bardata.map(function(d){ return d.date}));
	  y.domain([0, d3.max(bardata, function(d) { return d.average;})]);
  	x2.domain(x.domain());
	  y2.domain(y.domain());
		
  var brush = d3.svg.brush()
							  .x(x2) 
							  .on("brush", brushed);

var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);

var focus = svg.append("g")
    .attr("class", "focus")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
	
var context = svg.append("g")
    .attr("class", "context")
    .attr("transform", "translate(" + margin2.left + "," + margin2.top + ")");

  focus.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  focus.append("g")
      .attr("class", "y axis")
      .call(yAxis);
	 
  console.log(x(bardata[0].date))
 	enter(bardata)
  updateScale(bardata)
  enterSub(bardata)

  context.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height2 + ")")
      .call(xAxis2);

  context.append("g")
      .attr("class", "x brush")
      .call(brush)
    .selectAll("rect")
      .attr("y", -6)
      .attr("height", height2 + 7);
  



function brushed() {
    var selected = null; 
      selected =  x2.domain()
                .filter(function(d){
                 		return (brush.extent()[0] <= x2(d)) && (x2(d) <= brush.extent()[1]);
							});
  
    var start;
    var end;
		
  	if(brush.extent()[0] != brush.extent()[1])
      {
        start = selected[0];
		  	end = selected[selected.length - 1] + 1;
      } else { 
				start = 0;
				end = bardata.length;
      }

    var updatedData = bardata.slice(start, end);

    update(updatedData);
    enter(updatedData);
    exit(updatedData);
  	updateScale(updatedData)
 

}
 
  function updateScale(bardata)
  { 
    		var tickScale = d3.scale.pow().range([bardata.length / 10, 0]).domain([bardata.length, 0]).exponent(.5)

    var brushValue = brush.extent()[1] - brush.extent()[0];
    if(brushValue === 0){
      brushValue = width;
    }

    var tickValueMultiplier = Math.ceil(Math.abs(tickScale(brushValue)));  
  	var filteredTickValues = bardata.filter(function(d, i){return i % tickValueMultiplier === 0}).map(function(d){ return d.date})

    focus.select(".x.axis").call(xAxis.tickValues(filteredTickValues));
    focus.select(".y.axis").call(yAxis);
  }
  
  function update(bardata)
  {
		  x.domain(bardata.map(function(d){ return d.date}));
		  y.domain([0, d3.max(bardata, function(d) { return d.average;})]);

      var bars =  focus.selectAll('.bar')
          .data(bardata)
      bars
        .attr(
        {  
          height: function (d, i)
          { 
            return height - y(d.average);
          },
          width: function(d){ 
            return x.rangeBand()
          },
          x: function(d) {

            return x(d.date);
          },
          y: function(d)
          {
            return y(d.average)
          }
        })

  } 
  
  function exit(bardata)
  {
		var bars =  focus.selectAll('.bar').data(bardata)
		bars.exit().remove()
  }
  
  function enter(bardata)
  {
    	x.domain(bardata.map(function(d){ return d.date}));
		  y.domain([0, d3.max(bardata, function(d) { return d.average;})]);

      var bars =  focus.selectAll('.bar')
          .data(bardata)
      bars.enter().append("rect")
        .classed('bar', true)
        .attr(
        {  
          height: function (d, i)
          { 
            return height - y(d.average);
          },
          width: function(d){ 
            return x.rangeBand()
          },
          x: function(d) {
 
            return x(d.date);
          },
          y: function(d)
          {
            return y(d.average)
          }
        })
  }

  function enterSub(bardata) {
    console.log(bardata)
    var subBars = context.selectAll('.subBar')
                                  	.data(bardata)
	
    subBars.enter().append("rect")
        .classed('subBar', true)
        .attr(
        {
          height: function (d)
          {
            return height2 - y2(d.average);
          },
          width: function(d){ return x.rangeBand()},
          x: function(d) {

            return x2(d.date);
          },
          y: function(d)
          {
            return y2(d.average)
          }
        })
  }

  function exitSub(bardata)
  {
		var bars =  context.selectAll('.subBar').data(bardata)
		bars.exit().remove()
    console.log("Removed")
  }

</script>
<script>

var parseDate = function(value) {
         var m = value.match(/^(\d{1,2})(\/|-)?(\d{1,2})(\/|-)?(\d{4})$/);
         if (m)
             value = m[5] + '-' + ("00" + m[3]).slice(-2) + '-' + ("00" + m[1]).slice(-2);
 
         return value;
    }


  d3.csv("../CSV/tester.csv", function(error, data) {
    console.log(data)
    var selection = d3.select(".dropdead")
      .append("div")
      .append("label")
      .append("select")

    selection
      .on("change", function(d) {
        var value = d3.select(this).property("value");
        value = value.split(",")
        // console.log(typeof(value))
        // console.log((parseFloat(value[0])))

        exit(bardata)
        exitSub(bardata)
        bardata = []
        for (var i = 0; i < 300; i++) {
          var datum = {};
          datum.date = i;
          datum.average = i*0.1 + Math.random() *19.20 - Math.random() *3.620;
          bardata.push(datum);
        }  
        //Iterate through all the dates and averages for a city and append @AINSLEY
        // var datum = {};
        // console.log(value)
        
        // for(i=0; i<value.length ;i+=2)
        // { 
        //   bardata.push([parseDate(value[i]),parseFloat(value[i+1])]);
        // }
        console.log(bardata)
        enter(bardata)
        update(bardata)
        updateScale(bardata)
        enterSub(bardata)

        
      });
      // locations = new Set();
      // for(i in data)
      //   locations.add(data[i]["city"])
      // console.log(locations)        
      // temp = []
      
      // for (const k of locations.keys()) {
      //   temp.push({"city":k})
      // }

      // locations = temp
      // console.log(locations)

      selection.selectAll("option")
        // .data(locations)
        .data(data)
        .enter()
          .append("option")
          .attr("value", function (d) { 
            var temp = [parseDate(d.date), parseFloat(d.average)]
            // for(i in data)            
              // if(d.city == data[i]["city"])
              //   temp.push([parseDate(data[i]["date"]),parseFloat(data[i]["average"])])
    
            console.log(temp)
            return temp; })
          .text(function (d) { return d.city; });
  });
  </script>